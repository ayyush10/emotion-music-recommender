<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Callback</title>
</head>
<body>
  <p>Completing Spotify login‚Ä¶</p>
  script src="./js/spotify-auth.js"></script>t>
  <script>
    const CLIENT_ID = "2cb3f9d1752d46e8b7e5d397c2ab66b4";
    const isLocal = ["127.0.0.1", "localhost"].includes(window.location.hostname)
const redirectUri = isLocal
? "[http://127.0.0.1:5500/public/callback.html](http://127.0.0.1:5500/public/callback.html)"
: "[https://emotionmusicrecommender-fnqua08mc-ayuysh10s-projects.vercel.app/callback.html](https://emotionmusicrecommender-fnqua08mc-ayuysh10s-projects.vercel.app/callback.html)";
    console.log("üîç Redirect URI:", redirectUri);

    async function exchangeCodeForToken(code) {
      const codeVerifier = sessionStorage.getItem("spotify_code_verifier");
      if (!codeVerifier) {
        console.error("‚ùå No code_verifier found in sessionStorage.");
        alert("Login session expired. Please log in again.");
        window.location.href = "./index.html";
        return;
      }

      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        code_verifier: codeVerifier
      });

      try {
        const response = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const data = await response.json();
        console.log("üîë Token response:", data);

        if (data.access_token) {
          // ‚úÖ Use the helper from spotify-auth.js
          SpotifyAuth.saveToken({
            access_token: data.access_token,
            refresh_token: data.refresh_token,
            expires_in: data.expires_in,
            token_type: data.token_type
          });

          console.log("‚úÖ Token stored:", SpotifyAuth.loadToken());
          window.location.href = "./facedetection.html";
        } else {
          console.error("‚ùå Failed to obtain token:", data);
          alert("Failed to obtain Spotify token. Please try logging in again.");
          window.location.href = "./index.html";
        }
      } catch (err) {
        console.error("‚ùå Error exchanging code for token:", err);
        alert("Error during login. Please try again.");
        window.location.href = "./index.html";
      }
    }

    // ‚úÖ Run after defining function
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (code) {
      exchangeCodeForToken(code);
    } else {
      console.error("‚ùå No code in callback URL");
      window.location.href = "./index.html";
    }
  </script>
</body>
</html>
