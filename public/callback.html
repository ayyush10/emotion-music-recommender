<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spotify Callback</title>
</head>
<body>
  <p>Completing Spotify login…</p>
  <script src="./js/spotify-auth.js"></script>
  <script>
    const CLIENT_ID = "2cb3f9d1752d46e8b7e5d397c2ab66b4";
    const redirectUri = SpotifyAuth.getRedirectUri();
    console.log("[v0] Redirect URI used in token exchange:", redirectUri);

    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const returnedState = params.get("state");
    const expectedState = sessionStorage.getItem(SpotifyAuth.STATE_KEY);

    if (!code) {
      console.error("❌ No code in callback URL");
      alert("Missing authorization code. Please log in again.");
      window.location.href = "./index.html";
    }

    if (!returnedState || !expectedState || returnedState !== expectedState) {
      console.error("❌ State mismatch or missing. returned:", returnedState, "expected:", expectedState);
      alert("Login session mismatch. Please log in again.");
      window.location.href = "./index.html";
    }

    async function exchangeCodeForToken(code) {
      const codeVerifier = sessionStorage.getItem("spotify_code_verifier");
      if (!codeVerifier) {
        console.error("❌ No code_verifier found in sessionStorage.");
        alert("Login session expired. Please log in again.");
        window.location.href = "./index.html";
        return;
      }

      const body = new URLSearchParams({
        client_id: CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: redirectUri,
        code_verifier: codeVerifier
      });

      try {
        const response = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const text = await response.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }

        console.log("[v0] Token response status:", response.status);
        console.log("[v0] Token response body:", data);

        if (response.ok && data && data.access_token) {
          SpotifyAuth.saveToken({
            access_token: data.access_token,
            refresh_token: data.refresh_token,
            expires_in: data.expires_in,
            token_type: data.token_type
          });
          // Optional: clear one-time values
          sessionStorage.removeItem(SpotifyAuth.STATE_KEY);
          sessionStorage.removeItem("spotify_code_verifier");

          window.location.href = "./facedetection.html";
        } else {
          const msg = (data && (data.error_description || data.error)) || "Unknown error";
          alert("Failed to obtain Spotify token: " + msg + ". Please try logging in again.");
          console.error("❌ Failed to obtain token:", data);
          window.location.href = "./index.html";
        }
      } catch (err) {
        console.error("❌ Error exchanging code for token:", err);
        alert("Network error during login. Please try again.");
        window.location.href = "./index.html";
      }
    }

    if (code && returnedState && expectedState && returnedState === expectedState) {
      exchangeCodeForToken(code);
    }
  </script>
</body>
</html>
